---
## To record cassettes using this playbook (record_discovery_rule)
## you need to have the discovery plugin active
## $ foreman-installer --enable-foreman-plugin-discovery
##
## You also need the proxy to be setup with the DNS feature:
## $ foreman-installer --foreman-proxy-dns true
##

- hosts: localhost
  collections:
    - theforeman.foreman
  gather_facts: false
  vars_files:
    - vars/server.yml
    - vars/hostgroup.yml
  tasks:
    - include_tasks: tasks/location.yml
      vars:
        location_name: "{{ item }}"
        location_state: present
      with_items: "{{ hostgroup.locations }}"
    - include_tasks: tasks/organization.yml
      vars:
        organization_name: "{{ item }}"
        organization_state: present
      with_items: "{{ hostgroup.organizations }}"
    - include_tasks: tasks/domain.yml
      vars:
        domain_organizations: "{{ hostgroup.organizations }}"
        domain_locations: "{{ hostgroup.locations }}"
        domain_name: "{{ item }}"
        domain_dns_proxy: "{{ hostgroup.dns_proxy }}"
        domain_state: present
      with_items: "{{ hostgroup.domains }}"
    - include_tasks: tasks/subnet.yml
      vars:
        subnet_name: "{{ hostgroup.subnet }}"
        subnet_mask: '255.255.255.224'
        subnet_domains: "{{ hostgroup.domains }}"
        subnet_state: present
    - include_tasks: tasks/ptable.yml
      vars:
        ptable_name: "{{ hostgroup.ptable }}"
        ptable_os_family: "{{ hostgroup.os.family }}"
        ptable_locations: "{{ hostgroup.locations }}"
        ptable_organizations: "{{ hostgroup.organizations }}"
        ptable_state: present
    - include_tasks: tasks/operatingsystem.yml
      vars:
        operatingsystem_name: "{{ hostgroup.os.name }}"
        operatingsystem_major: "{{ hostgroup.os.major }}"
        operatingsystem_minor: "{{ hostgroup.os.minor }}"
        operatingsystem_family: "{{ hostgroup.os.family }}"
        operatingsystem_architectures:
          - "{{ hostgroup.arch }}"
        operatingsystem_ptables:
          - "{{ hostgroup.ptable }}"
        operatingsystem_state: present
    - include_tasks: tasks/installation_medium.yml
      vars:
        installation_medium_name: "{{ hostgroup.os.name }} Mirror"
        installation_medium_operatingsystems:
          - "{{ hostgroup.os.name }} {{ hostgroup.os.major }}.{{ hostgroup.os.minor }}"
        installation_medium_locations: "{{ hostgroup.locations }}"
        installation_medium_organizations: "{{ hostgroup.organizations }}"
        installation_medium_state: present
    - include_tasks: tasks/hostgroup.yml
      vars:
        hostgroup_name: "Discovery hostgroup"
        hostgroup_description: "Discovery hostgroup"
        hostgroup_architecture: "{{ hostgroup.arch }}"
        hostgroup_operatingsystem: "{{ hostgroup.os.name }} {{ hostgroup.os.major }}.{{ hostgroup.os.minor }}"
        hostgroup_locations: "{{ hostgroup.locations }}"
        hostgroup_organizations: "{{ hostgroup.organizations }}"
        hostgroup_domain: "{{ hostgroup.domains | first }}"
        hostgroup_subnet: "{{ hostgroup.subnet }}"
        hostgroup_installation_medium: "{{ hostgroup.os.name }} Mirror"
        hostgroup_ptable: "{{ hostgroup.ptable }}"
        hostgroup_pxe_loader: "Grub2 UEFI"
        hostgroup_parameters:
          - name: subnet_param1
            value: value1
          - name: subnet_param2
            value: value2
        hostgroup_state: present
    - include_tasks: tasks/discovery_rule.yml
      vars:
        discovery_rule_name: 'New-discovery-rule'
        discovery_rule_state: 'absent'

- hosts: tests
  collections:
    - theforeman.foreman
  gather_facts: false
  vars_files:
    - vars/server.yml
    - vars/hostgroup.yml
  tasks:
    - include_tasks: tasks/discovery_rule.yml
      vars:
        discovery_rule_name: 'New-discovery-rule'
        discovery_rule_search: 'mac = aa:aa:aa:aa:aa:aa'
        discovery_rule_hostgroup: 'Discovery hostgroup'
        discovery_rule_hostname: 'discovered-host'
        discovery_rule_max_count: '1'
        discovery_rule_organizations: "{{ hostgroup.organizations }}"
        discovery_rule_locations: "{{ hostgroup.locations }}"
        discovery_rule_state: 'present'
        expected_change: true

    - include_tasks: tasks/discovery_rule.yml
      vars:
        discovery_rule_name: 'New-discovery-rule'
        discovery_rule_search: 'mac = aa:aa:aa:aa:aa:aa'
        discovery_rule_hostgroup: 'Discovery hostgroup'
        discovery_rule_hostname: 'discovered-host'
        discovery_rule_max_count: '1'
        discovery_rule_organizations: "{{ hostgroup.organizations }}"
        discovery_rule_locations: "{{ hostgroup.locations }}"
        discovery_rule_state: 'present'
        expected_change: false

    - include_tasks: tasks/discovery_rule.yml
      vars:
        discovery_rule_name: 'New-discovery-rule'
        discovery_rule_state: 'absent'
        expected_change: true
